<html>
  <script src="/lib/jquery-3.6.0.min.js"></script>

<style>
  @font-face {
    font-family: "cookierun";
    src: url("/res/font/CookieRun.ttf");
  }
  .comment{
    background-color: rgb(160, 160, 160);
    padding: 50px;
    display: inline-block;
  }
  .delete_comment{
    cursor: pointer;
    background-color: red;
  }
  .vote{
    cursor: pointer;
    display: inline-block;
  }
  .vote a{
    font-size: 15px;
  }
  .vote img{
    width: 15px;
  }
  .downvote img{
    transform: rotate(180deg);
  }
</style>
<head>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.2, user-scalable=no" />

  <meta charset="utf-8" >
</head>

<body>
    <h5>답글 작성</h5>
    <%if(postUrl!==""){%>
      <a href="/board/post/<%=postUrl%>">x</a>
    <%}else{%>
    <p> 원글이 삭제된 댓글입니다</p>
    <%}%>
    
    <%if(comment.deleted){%>
        <p> 삭제된 댓글입니다</p>
    <%}else{%>
        <p> <%= comment.content %> </p>
        <b onclick="golink('/board/user/<%=comment.authorName%>/comments')"> <%= comment.authorName %> </b>

        <div class="vote upvote commentvote" data-type="up" data-id="<%=comment._id%>" >
          <img src="/res/img/svg/like.svg">
          <a class="vote_count"><%= comment.upvote %></a>
        </div>
        <div class="vote downvote commentvote" data-type="down" data-id="<%=comment._id%>" >
          <img src="/res/img/svg/like.svg">
          <a class="vote_count"><%= comment.downvote %></a>
        </div>
    <%}%>
    <%for(let i=reply.length-1;i>=0;--i){%>
      <% const r=reply[i]%>
        <div class="comment">
                <b onclick="golink('/board/user/<%=r.author%>/comments')"> <%= r.author %> </b>
                <p> <%= r.content %> </p><br>
                <%if(r.canModify){%>
                    <button value="<%= r._id%>" class="delete_comment">&times;</button>
                <%}%>
                <div class="vote upvote replyvote" data-type="up" data-id="<%=r._id%>" >
                  <img src="/res/img/svg/like.svg">
                  <a class="vote_count"><%= r.upvotes %></a>
                </div>
                <div class="vote downvote replyvote" data-type="down" data-id="<%=r._id%>" >
                  <img src="/res/img/svg/like.svg">
                  <a class="vote_count"><%= r.downvotes %></a>
                </div>
        </div>
    <%}%>
        <%if(logined){%>
            <form action="/board/post/comment/reply" method="post"> 
                <input type="hidden" name="commentId" value="<%= comment._id %>">  
                <input type="text" name="content" required>
                <input type="submit">
             </form>
        <%}else{%>
            <p>답글을 쓰려면 로그인하세요</p>
       <% }%>

</body>
<script>
function golink(link){
  window.location.href=link
}
$(".delete_comment").click(function(){
  
  let value=$(this).val()
  $.ajax({
        method: 'POST',
        url: '/board/post/reply/delete',
        data:{commentId:value}
    })
    .done(function(data, statusText, xhr){
      let status = xhr.status;
        window.location.reload()
      
    })
    .fail(function(data, statusText, xhr){
        alert("error")
      
    })
})

$(".replyvote").click(function(){
  let type=$(this).data('type')
  let id=$(this).data('id')
  sendVote('reply',type,id,$(this).children('.vote_count').eq(0))
})
$(".commentvote").click(function(){
  let type=$(this).data('type')
  let id=$(this).data('id')
  sendVote('comment',type,id,$(this).children('.vote_count').eq(0))
})

function sendVote(kind,type,id,vote_count){
  $.ajax({
        method: 'POST',
        url: '/board/'+kind+'/vote',
        data:{id:id,type:type}
    })
    .done((data, statusText, xhr)=>{
      let status = xhr.status;
      if(status==200){
        $(vote_count).html(Number($(vote_count).html()) +  data.change)
      }
    })
    .fail((data, statusText, xhr)=>{
      if(data.status==401){
        alert("로그인이 필요합니다")
      }
    })
}
</script>
</html>